<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Avatar Clipper 轻量级图片裁剪工具</title>
	<link rel="shortcut icon" href="../favicon.ico" type="image/x-icon">
	<link rel="stylesheet" href="./index.css">
</head>

<body>
	<div id="app">
		<h2 class="title">Avatar Clipper</h2>
		<p class="sub-title">Easily crop and customize your avatar images</p>
		<!-- 主容器 -->
		<div class="container">
			<!-- 左侧裁剪框 -->
			<div class="clipper">
				<!-- 头像裁剪框 -->
				<div class="clipper-box">
					<div id="avatar-clipper-container"></div>
				</div>
				<!-- 按钮 -->
				<div class="clipper-btns">
					<button data-event="upload">
						<svg class="icon" viewBox="0 0 1024 1024" version="1.1" fill="currentColor"
							stroke="currentColor" xmlns="http://www.w3.org/2000/svg" width="120" height="120">
							<path
								d="M823.424 395.296l-287.52-289.248c-3.2-3.2-6.88-5.536-10.816-7.104C521.056 97.12 516.672 96 512 96c-11.264 0-20.704 6.176-26.4 14.976l-254.4 253.952c-12.512 12.48-12.544 32.736-0.032 45.248 6.24 6.272 14.432 9.376 22.656 9.376 8.16 0 16.352-3.104 22.624-9.344L480 206.976 480 768c0 17.696 14.336 32 32 32s32-14.304 32-32L544 204.96l234.048 235.456c6.24 6.272 14.464 9.44 22.688 9.44 8.16 0 16.32-3.104 22.56-9.312C835.84 428.096 835.904 407.84 823.424 395.296z">
							</path>
							<path
								d="M896 704c-17.696 0-32 14.304-32 32l0 128L160 864l0-128c0-17.696-14.336-32-32-32s-32 14.304-32 32l0 160c0 17.696 14.336 32 32 32l768 0c17.696 0 32-14.304 32-32l0-160C928 718.304 913.696 704 896 704z">
							</path>
						</svg>
						上传
					</button>
					<button data-event="clear">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
							stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<path d="M3 6h18"></path>
							<path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
							<path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
							<line x1="10" x2="10" y1="11" y2="17"></line>
							<line x1="14" x2="14" y1="11" y2="17"></line>
						</svg>
						清空
					</button>
					<button data-event="reset">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
							stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
							<path d="M21 3v5h-5"></path>
							<path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
							<path d="M8 16H3v5"></path>
						</svg>
						重置
					</button>
					<button data-event="reduce">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
							stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<circle cx="11" cy="11" r="8"></circle>
							<line x1="21" x2="16.65" y1="21" y2="16.65"></line>
							<line x1="11" x2="11" y1="8" y2="14"></line>
							<line x1="8" x2="14" y1="11" y2="11"></line>
						</svg>
						缩小
					</button>
					<button data-event="enlarge">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
							stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<circle cx="11" cy="11" r="8"></circle>
							<line x1="21" x2="16.65" y1="21" y2="16.65"></line>
							<line x1="8" x2="14" y1="11" y2="11"></line>
						</svg>
						放大
					</button>
					<button data-event="rotate">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
							stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path>
							<path d="M21 3v5h-5"></path>
						</svg>
						旋转
					</button>
				</div>
			</div>
			<!-- 右侧属性设置 -->
			<div class="operator">
				<!-- 预览 -->
				<div class="tabs">
					<button class="tab-button active">Preview</button>
				</div>
				<div class="preview-list">
					<div class="preview-item-circle">
						<img style="height: 60px;width:60px" src="" alt="" />
						<img style="height: 40px;width:40px" src="" alt="" />
						<img style="height: 30px;width:30px" src="" alt="" />
					</div>
					<div class="preview-item-square">
						<img style="height: 60px;width:60px" src="" alt="" />
						<img style="height: 40px;width:40px" src="" alt="" />
						<img style="height: 30px;width:30px" src="" alt="" />
					</div>
				</div>
				<!-- 属性设置 -->
				<div class="tabs clipper-tabs" style="margin-top: 10px">
					<button data-btn-type="image" class="tab-button active">Image</button>
					<button data-btn-type="crop" class="tab-button">Crop</button>
					<button data-btn-type="watermark" class="tab-button">Watermark</button>
				</div>

				<!-- 属性设置面板 -->
				<div class="setting-box tab-content">
					<!-- 图片属性设置 -->
					<div id="setting-for-image">
						<div class="setting-item color-picker">
							<label id="background-color" for="background-color">Background Color</label>
							<div class="color-input">
								<input type="color" name="background-color" id="background-color" />
								<input autocomplete="off" type="text" name="background-color-input"
									id="background-color-input" value="transparent" />
							</div>
						</div>
						<div style="border-bottom: solid #e4e4e7  1px;margin: 10px 0;"></div>
						<!-- 是否启用右键菜单 -->
						<div class="setting-item setting-item-flex">
							<input type="checkbox" checked name="enable-contextmenu" id="enable-contextmenu" />
							<label id="enable-contextmenu" for="enable-contextmenu">Enable contextmenu</span>
						</div>
						<div class="setting-item setting-item-flex">
							<input type="checkbox" checked name="image-draggable" id="image-draggable" />
							<label id="image-draggable" for="image-draggable">Can drag image</span>
						</div>
						<div class="setting-item setting-item-flex">
							<input type="checkbox" checked name="image-zoom" id="image-zoom" />
							<label id="image-zoom" for="image-zoom">Can resize image</span>
						</div>
					</div>

					<!-- 水印属性设置 -->
					<div style="display: none;" id="setting-for-watermark">
						<div class="setting-item color-picker">
							<label id="watermark-text" for="watermark-text">Watermark Text</label>
							<div class="color-input">
								<input autocomplete="off" type="text" name="watermark-text" id="watermark-text"
									value="Avatar Clipper" />
							</div>
						</div>
						<div class="setting-item color-picker">
							<label id="watermark-color" for="watermark-color">Watermark Color</label>
							<div class="color-input">
								<input type="color" name="watermark-color" id="watermark-color" />
								<input autocomplete="off" type="text" name="watermark-color-input"
									id="watermark-color-input" value="#000000" />
							</div>
						</div>
						<div class="setting-item color-picker">
							<label id="watermark-rotation" for="watermark-rotation">Angle And FontSize</label>
							<div class="color-input">
								<span style="font-size: 12px;">Angle:</span>
								<input autocomplete="off" type="number" name="watermark-rotation"
									id="watermark-rotation" value="-45" />

								<span style="font-size: 12px;">FontSize:</span>
								<input autocomplete="off" type="number" name="watermark-font-size"
									id="watermark-font-size" value="20" />
							</div>
						</div>
						<div class="setting-item color-picker">
							<label id="watermark-gap" for="watermark-gap">Watermark Gap</label>
							<div class="color-input">
								<span style="font-size: 12px;">GapX:</span>
								<input autocomplete="off" type="number" name="watermark-gap-x" id="watermark-gap-x"
									value="20" />
								<span style="font-size: 12px;">GapY:</span>
								<input autocomplete="off" type="number" name="watermark-gap-y" id="watermark-gap-y"
									value="50" />
							</div>
						</div>
					</div>

					<!-- 裁剪框属性 -->
					<div style="display: none;" id="setting-for-crop">
						<div class="setting-item color-picker">
							<label id="crop-anchor-fill" for="crop-anchor-fill">Crop anchor fill</label>
							<div class="color-input">
								<input type="color" value="#299CF5" name="crop-anchor-fill" id="crop-anchor-fill" />
								<input autocomplete="off" type="text" name="crop-anchor-fill-input"
									id="crop-anchor-fill-input" value="#299CF5" />
							</div>
						</div>
						<div class="setting-item color-picker">
							<label id="crop-anchor-stroke" for="crop-anchor-stroke">Crop anchor stroke</label>
							<div class="color-input">
								<input type="color" value="#299CF5" name="crop-anchor-stroke" id="crop-anchor-stroke" />
								<input autocomplete="off" type="text" name="crop-anchor-stroke-input"
									id="crop-anchor-stroke-input" value="#299CF5" />
							</div>
						</div>
						<div class="setting-item setting-item-flex">
							<input type="checkbox" name="crop-fixed" id="crop-fixed" />
							<label id="crop-fixed" for="crop-fixed">Fixed aspect ratio</span>
						</div>
						<div class="setting-item setting-item-flex">
							<input type="checkbox" checked name="crop-draggable" id="crop-draggable" />
							<label id="crop-draggable" for="crop-draggable">Can drag crop frame</span>
						</div>
						<div class="setting-item setting-item-flex">
							<input type="checkbox" checked name="crop-resize" id="crop-resize" />
							<label id="crop-resize" for="crop-resize">Can resize crop frame</span>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- 使用 ES Module 实现 avatar-clipper 的引入 -->
	<script type="module">
		import AvatarClipper from "https://unpkg.com/avatar-clipper";

		const clipper = new AvatarClipper({ container: "#avatar-clipper-container", image: { src: "https://picsum.photos/200/300" } });


		/**
		 * 定义图片的基础属性,用于后期变换使用
		 */
		const imageAttrs = { scaleX: 1, scaleY: 1, rotation: 0 };

		// 定义缩小放大步频
		const scaleStep = 0.2;

		// 获取所有的图片对象
		const imageList = document.querySelectorAll(".preview-list img");

		// 图片加载失败时，尝试加载新的图片资源
		clipper.event.on("imageError", () => clipper.command.setImage("https://picsum.photos/200/300"));

		// 监听 preview 事件,对预览结果进行初始化
		clipper.event.on("preview", (result) => imageList.forEach((item) => (item.src = result)));

		// 监听 afterInit 事件，初始化第一次图片资源
		clipper.event.on("afterInit", (result) => imageList.forEach((item) => (item.src = result)));

		// 监听 imageUpload 图片更新事件
		clipper.event.on("imageUpdate", (attrs) => {
			imageAttrs.scaleX = attrs.scaleX;
			imageAttrs.scaleY = attrs.scaleY;
			imageAttrs.rotation = attrs.rotation;
		});

		// 定义事件映射列表
		const eventMap = {
			upload,
			clear: clipper.command.clearImage,
			reset: clipper.command.reset,
			enlarge: () => clipper.command.updateImageAttrs({ scaleX: imageAttrs.scaleX + scaleStep, scaleY: imageAttrs.scaleY + scaleStep }),
			reduce: () => clipper.command.updateImageAttrs({ scaleX: imageAttrs.scaleX - scaleStep, scaleY: imageAttrs.scaleY - scaleStep }),
			rotate: () => clipper.command.updateImageAttrs({ rotation: imageAttrs.rotation + 45 }),
		};

		// 上传 | 清空 | 重置 | 缩小 | 放大 | 旋转
		const buttons = document.querySelectorAll(".clipper-btns button");
		buttons.forEach((btn) => {
			btn.addEventListener("click", () => {
				const event = btn.dataset.event;
				if (event && eventMap[event]) eventMap[event]();
			});
		});

		/** 上传图片 **/
		function upload() {
			const input = document.createElement("input");
			input.type = "file";
			input.accept = "image/*";
			input.onchange = function () {
				const image = input.files[0];
				if (!image) return;
				// 调用 command 方法
				clipper.command.setImage(image);
				input.value = "";
				input.remove();
			};
			input.click();
		}

		// Image | Crop | Watermark tab 切换
		const tabs = document.querySelectorAll(".clipper-tabs button.tab-button");
		// 获取 tab 对应的内容
		const tabContents = document.querySelectorAll(".tab-content > div");
		tabs.forEach((tab) => {
			tab.addEventListener("click", () => {
				const type = tab.dataset.btnType;
				if (!type) return;

				// 给当前点击的 button 添加 active 类
				tabs.forEach((item) => item.classList.remove("active"));
				tab.classList.add("active");

				// 处理 container 内容显示 切换的核心： id="setting-for-image"
				tabContents.forEach((item) => {
					item.style.display = item.id === `setting-for-${type}` ? "block" : "none";
				});
			});
		});

		// set background color
		const backgroundColorPicker = document.querySelector("input#background-color");
		const backgroundColorInput = document.querySelector("input#background-color-input");
		backgroundColorPicker.addEventListener("change", () => {
			backgroundColorInput.value = backgroundColorPicker.value;
			clipper.command.updateClipperOptions({ backgroundColor: backgroundColorInput.value });
		});
		backgroundColorInput.addEventListener("input", () => {
			backgroundColorPicker.value = backgroundColorInput.value;
			clipper.command.updateClipperOptions({ backgroundColor: backgroundColorInput.value });
		});

		// enable contextmenu
		const enableContextmenu = document.querySelector("input#enable-contextmenu");
		enableContextmenu.addEventListener("change", () => {
			const enable = enableContextmenu.checked;
			clipper.command.updateClipperOptions({ enableContextmenu: enable });
		});

		// set image draggable
		const imageDraggable = document.querySelector("input#image-draggable");
		imageDraggable.addEventListener("change", () => {
			const draggable = imageDraggable.checked;
			clipper.command.updateImageAttrs({ draggable });
		});

		// set image zoom
		const imageZoom = document.querySelector("input#image-zoom");
		imageZoom.addEventListener("change", () => {
			const zoom = imageZoom.checked;
			clipper.command.updateImageAttrs({ zoom });
		});

		// set crop anchor fill
		const cropAnchorFillPicker = document.querySelector("input#crop-anchor-fill");
		const cropAnchorFillInput = document.querySelector("input#crop-anchor-fill-input");
		cropAnchorFillPicker.addEventListener("change", () => {
			cropAnchorFillInput.value = cropAnchorFillPicker.value;
			clipper.command.updateCropAttrs({ fill: cropAnchorFillInput.value });
		});
		cropAnchorFillInput.addEventListener("input", () => {
			cropAnchorFillPicker.value = cropAnchorFillInput.value;
			clipper.command.updateCropAttrs({ fill: cropAnchorFillInput.value });
		});

		// set crop anchor stroke
		const cropAnchorStrokePicker = document.querySelector("input#crop-anchor-stroke");
		const cropAnchorStrokeInput = document.querySelector("input#crop-anchor-stroke-input");
		cropAnchorStrokePicker.addEventListener("change", () => {
			cropAnchorStrokeInput.value = cropAnchorStrokePicker.value;
			clipper.command.updateCropAttrs({ stroke: cropAnchorStrokeInput.value });
		});
		cropAnchorStrokeInput.addEventListener("input", () => {
			cropAnchorStrokePicker.value = cropAnchorStrokeInput.value;
			clipper.command.updateCropAttrs({ stroke: cropAnchorStrokeInput.value });
		});

		// set crop fixed ratio
		const cropFixed = document.querySelector("input#crop-fixed");
		cropFixed.addEventListener("change", () => clipper.command.updateCropAttrs({ fixed: cropFixed.checked }));

		// set crop draggable
		const cropDraggable = document.querySelector("input#crop-draggable");
		cropDraggable.addEventListener("change", () => clipper.command.updateCropAttrs({ draggable: cropDraggable.checked }));

		// set crop resize
		const cropResize = document.querySelector("input#crop-resize");
		cropResize.addEventListener("change", () => clipper.command.updateCropAttrs({ resize: cropResize.checked }));

		// set watermark text
		const watermarkText = document.querySelector("input#watermark-text");
		watermarkText.addEventListener("input", () => clipper.command.updateWatermarkAttrs({ text: watermarkText.value }));

		// set watermark color
		const watermarkColorPicker = document.querySelector("input#watermark-color");
		const watermarkColorInput = document.querySelector("input#watermark-color-input");
		watermarkColorPicker.addEventListener("change", () => {
			watermarkColorInput.value = watermarkColorPicker.value;
			clipper.command.updateWatermarkAttrs({ color: watermarkColorInput.value });
		});
		watermarkColorInput.addEventListener("input", () => {
			watermarkColorPicker.value = watermarkColorInput.value;
			clipper.command.updateWatermarkAttrs({ color: watermarkColorInput.value });
		});

		// set watermark angle
		const watermarkRotation = document.querySelector("input#watermark-rotation");
		watermarkRotation.addEventListener("input", () => clipper.command.updateWatermarkAttrs({ rotation: +watermarkRotation.value }));

		// set watermark font size
		const watermarkFontSize = document.querySelector("input#watermark-font-size");
		watermarkFontSize.addEventListener("input", () => clipper.command.updateWatermarkAttrs({ fontSize: +watermarkFontSize.value }));

		// set watermark gap x
		const watermarkGapX = document.querySelector("input#watermark-gap-x");
		const watermarkGapY = document.querySelector("input#watermark-gap-y");
		watermarkGapX.addEventListener("input", () => clipper.command.updateWatermarkAttrs({ gap: [+watermarkGapX.value, +watermarkGapY.value] }));
		watermarkGapY.addEventListener("input", () => clipper.command.updateWatermarkAttrs({ gap: [+watermarkGapX.value, +watermarkGapY.value] }));
	</script>
</body>

</html>